// SVG encoding mixins for fun and profit
// (string encoding functions h/t http://codepen.io/jakob-e/pen/doMoML)

$svg-images: () !global;

@function str-replace($string, $search, $replace: '') {
  $index: str-index($string, $search);
  @if $index {
    @return str-slice($string, 1, $index - 1) + $replace +
    str-replace(str-slice($string, $index +
    str-length($search)), $search, $replace);
  }
  @return $string;
}

@function svg-encode($svg){
  $encoded:'';
  $slice: 2000;
  $index: 0;
  $loops: ceil(str-length($svg)/$slice);
  @for $i from 1 through $loops {
    $chunk: str-slice($svg, $index, $index + $slice - 1);
    $chunk: str-replace($chunk,'"','\'');
    $chunk: str-replace($chunk,'<','%3C');
    $chunk: str-replace($chunk,'>','%3E');
    $chunk: str-replace($chunk,'&','%26');
    $chunk: str-replace($chunk,'#','%23');
    $encoded: #{$encoded}#{$chunk};
    $index: $index + $slice;
  }
  @return url("data:image/svg+xml;charset=utf8,#{$encoded}");
}

@function svg-url($name) {
  $icon: map-get($svg-images, $name);
  $width: map-get($icon, width);
  $height: map-get($icon, height);

  $path: "<svg version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' viewBox='0 0 #{$width} #{$height}' width='#{$width}px' height='#{$height}px' shape-rendering='geometricPrecision'>#{map-get($icon, path)}</svg>";

  @return svg-encode($path);
}

@mixin register-svg($name, $width, $height, $path) {
  $new-icon: (
    $name: (
      width: $width,
      height: $height,
      path: $path
    )
  );
  $svg-images: map-merge($svg-images, ($new-icon)) !global;
}
